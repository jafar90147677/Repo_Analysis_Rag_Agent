<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session e7ba4531-35d2-4088-bad6-649698b3f8ce (2026-01-29 07:33Z) -->

# Index route concurrency enforcement (2026-01-29 07:33Z)

_**User**_

**CONSTRAINT A:** Only include code/text explicitly provided below.
**CONSTRAINT B:** Ignore all prior conversation history.
**CONSTRAINT C:** Use static instructions followed by dynamic content; avoid variable metadata before the task text.
**CONSTRAINT D:** Limit output strictly to the requested answer; no explanations, no extra text.
**CONSTRAINT E:** Do not repeat input in the output.
**CONSTRAINT F:** Only perform the stated task and nothing else.
**CONSTRAINT G:** Do not scan the repo and send as context. Until and unless specified explicitly.

---

### **Title:** MT-33-D â€” `/index` Route Concurrency Enforcement

**Goal:**
Enforce repo-scoped concurrency at the API boundary so that concurrent `/index` requests for the same `repo_id` are blocked before any indexing logic executes.

**Files:**

* Edit: `edge-agent/app/api/routes.py`

**Implementation Notes (binding):**

* Use existing root path normalization logic as defined by the PRD.
* Compute `repo_id` deterministically from the normalized `root_path`.
* Invoke the read-only indexing state check exposed by the indexer layer.
* If indexing is already in progress for the computed `repo_id`:

  * Do not invoke any indexing logic.
  * Immediately return an error response (error payload handled in a separate microtask).
* No mutation of indexing state in this task.
* Deterministic, safe by default, and side-effect free except for request rejection.

**How to verify:**

* Unit tests:

  * `Zeroui_Repo_Analysis_Rag_Agent/offline-folder-rag/unittests/unittest_cases/`

    * Add or update a test to:

      * Simulate an active indexing state for a `repo_id`
      * Call the `/index` route with the same `root_path`
      * Assert the request is blocked before indexing starts
* Manual check:

  * Start an index request and immediately issue a second `/index` request for the same folder; confirm the second request is rejected without starting work.

**Done =**
The `/index` route deterministically checks indexing state using `repo_id` and blocks concurrent requests before any indexing execution begins.


---

_**Agent (model gpt-5.1-codex-mini, mode Agent)**_

<think><details><summary>Thought Process</summary>
**Planning file inspection and constraints**</details></think>

---

File not found

---

